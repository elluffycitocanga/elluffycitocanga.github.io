<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Campus UCE</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f0f0f0;
    }

    h1 {
      text-align: center;
      background-color: #222;
      color: #fff;
      margin: 0;
      padding: 20px 0;
      font-size: 32px;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start; /* Para que el panel lateral quede arriba alineado */
      gap: 20px; /* Separación entre imagen y panel */
      padding: 20px;
    }

    /* Recuadro para el canvas (imagen + nodos) */
    .canvas-wrapper {
      background-color: #000;
      width: 750px;    /* Ajustado para que sea más pequeño */
      height: 400px;   /* Relación de aspecto 985x442 redimensionado */
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      border: 2px solid black; /* Borde negro */
      flex-shrink: 0; /* No se reduzca */
    }

    canvas {
      position: absolute;
      left: 0;
      top: 0;
      user-select: none;
    }

    /* Panel lateral para mostrar info del nodo */
    .info-panel {
      width: 300px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      border: 2px solid black; /* Borde negro */
      padding: 15px;
      font-size: 14px;
      color: #222;
      line-height: 1.4;
      user-select: text;
    }

    .info-panel img {
      max-width: 100%;
      margin-bottom: 10px;
      border-radius: 8px;
      display: none; /* Oculto inicialmente */
    }

    .info-panel h2 {
      margin-top: 0;
      font-size: 18px;
    }

    .info-panel ul {
      padding-left: 20px;
      margin-top: 5px;
    }

    .modo-btn {
      background-color: white;
      color: black;
      border: 1px solid #333;
      padding: 10px 20px;
      margin: 0 5px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Segoe UI', sans-serif;
      transition: all 0.3s ease;
    }

    .modo-btn:hover {
      background-color: #f0f0f0;
    }

    .modo-btn.active {
      background-color: black;
      color: white;
      border: 1px solid black;
    }

  </style>
</head>
<body>
  <h1>CAMPUS UCE</h1>

  <div id="modoSelector" style="text-align: center; margin: 1rem 0;">
    <button id="btnFacultades" class="modo-btn active">Facultades UCE</button>
    <button id="btnEncuentra" class="modo-btn">Encuentra tu facultad :D</button>
  </div>

  <div class="container">
    <div class="canvas-wrapper" id="canvas-container">
      <canvas id="canvas"></canvas>
    </div>
  
    <!-- Panel lateral fijo para la info -->
    <div id="info-panel" class="info-panel">
      <h2 id="panel-title">Selecciona un nodo</h2>
      <img id="panel-image" src="" alt="Imagen Facultad" />
      <p id="panel-info"></p>
      <div id="panel-carreras"></div>
    </div>
  </div>

  <script>
    let currentMode = 'facultades'; // 'campus' o 'rutas'
    document.getElementById('btnFacultades').addEventListener('click', () => {
      setActiveMode('facultades');
    });
    document.getElementById('btnEncuentra').addEventListener('click', () => {
      setActiveMode('encuentra');
    });

    function setActiveMode(mode) {
      if (currentMode === mode) return;

      currentMode = mode;

      if (mode === 'facultades') {
        loadData('campus.json');
      } else {
        loadData('rutas.json');
      }

      document.querySelectorAll('.modo-btn').forEach(btn => btn.classList.remove('active'));
      if (mode === 'facultades') {
        document.getElementById('btnFacultades').classList.add('active');
      } else {
        document.getElementById('btnEncuentra').classList.add('active');
      }

      resetCanvasState();
    }

    function resetCanvasState() {
      nodes = [];
      edges = [];
      subnodes = [];
      routePath = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Puedes también reiniciar variables relacionadas con Dijkstra si es necesario
    }
    const canvas = document.getElementById('canvas');
    const container = document.getElementById('canvas-container');
    const ctx = canvas.getContext('2d');

    const panelTitle = document.getElementById('panel-title');
    const panelInfo = document.getElementById('panel-info');
    const panelCarreras = document.getElementById('panel-carreras');
    const panelImage = document.getElementById('panel-image');

    let nodes = [];
    let edges = [];
    let image = new Image();
    let modoActual = 'facultades'; // 'facultades' o 'encuentra'
    let nodos = [];
    let aristas = [];

    image.src = 'fondo.jpg';  // Solo una imagen ahora

    let scale = 1;
    let minScale = 1;
    let maxScale = 2;  // 200% zoom max
    let offsetX = 0;
    let offsetY = 0;
    let isDragging = false;
    let startDrag = { x: 0, y: 0 };
    let selectedNode = null;

    const fixedSubnodePositions = {
      23: {x: 852, y: 138 },
      24: {x: 470, y: 265 },
      25: {x: 495, y: 272 },
      26: {x: 471, y: 245 },
      27: {x: 498, y: 231 },
      28: {x: 525, y: 218 },
      29: {x: 552, y: 204 },
      30: {x: 447, y: 289 },
      31: {x: 449, y: 320 },
      32: {x: 633, y: 222 },
      33: {x: 606, y: 207 },
      34: {x: 632, y: 246 },
      35: {x: 604, y: 254 },
      36: {x: 577, y: 263 },
      37: {x: 549, y: 271 },
      38: {x: 521, y: 73  },      
      39: {x: 550, y: 70  },      
      40: {x: 676, y: 77  },      
      41: {x: 617, y: 76  },      
      42: {x: 555, y: 87  },      
      43: {x: 819, y: 328 },
      44: {x: 821, y: 298 },
      45: {x: 824, y: 267 },
      46: {x: 826, y: 237 },
      47: {x: 790, y: 358 },
      48: {x: 764, y: 358 },
      49: {x: 738, y: 357 },
      50: {x: 712, y: 357 },
      51: {x: 686, y: 356 },
      52: {x: 660, y: 356 },
      53: {x: 634, y: 355 },
      54: {x: 608, y: 354 },
      55: {x: 582, y: 354 },
      56: {x: 556, y: 353 },
      57: {x: 530, y: 353 },
      58: {x: 504, y: 352 },
      59: {x: 478, y: 352 },
      60: {x: 790, y: 339 },
      61: {x: 764, y: 319 },
      62: {x: 738, y: 299 },
      63: {x: 712, y: 278 },
      64: {x: 686, y: 258 },
      65: {x: 814, y: 159 },
      66: {x: 798, y: 148 },
      67: {x: 782, y: 138 },
      68: {x: 766, y: 127 },
      69: {x: 750, y: 117 },
      70: {x: 734, y: 106 },
      71: {x: 718, y: 96  },      
      72: {x: 504, y: 297 },
      73: {x: 487, y: 315 },
      74: {x: 469, y: 333 },
      75: {x: 565, y: 213 },
      76: {x: 550, y: 235 },
      77: {x: 536, y: 257 },
      78: {x: 566, y: 166 },
      79: {x: 552, y: 141 },
      80: {x: 539, y: 115 },
      81: {x: 620, y: 156 },
      82: {x: 661, y: 120 },
      83: {x: 580, y: 164 },
      84: {x: 582, y: 138 },
      85: {x: 583, y: 111 },
      86: {x: 835, y: 144 },
      87: {x: 279, y: 225 },
      88: {x: 307, y: 231 },
      89: {x: 334, y: 236 },
      90: {x: 362, y: 242 },
      91: {x: 389, y: 247 },
      92: {x: 417, y: 253 },
      93: {x: 277, y: 236 },
      94: {x: 302, y: 253 },
      95: {x: 327, y: 269 },
      96: {x: 352, y: 286 },
      97: {x: 377, y: 302 },
      98: {x: 402, y: 318 },
      99: {x: 427, y: 335 },
      100: {x: 278, y: 204},
      101: {x: 305, y: 187},
      102: {x: 331, y: 171},
      103: {x: 358, y: 154},
      104: {x: 384, y: 138},
      105: {x: 410, y: 122},
      106: {x: 437, y: 105},
      107: {x: 463, y: 89 },      
      108: {x: 490, y: 72 },      
      109: {x: 795, y: 212},
      110: {x: 761, y: 219},
      111: {x: 728, y: 225},
      112: {x: 694, y: 232},
      113: {x: 859, y: 190},
      114: {x: 890, y: 173},
      115: {x: 920, y: 157},
      116: {x: 846, y: 182},
      117: {x: 504, y: 323},
      118: {x: 556, y: 295},
      119: {x: 608, y: 266},
      120: {x: 48, y: 87  },     
      121: {x: 74, y: 103 },      
      122: {x: 99, y: 120 },      
      123: {x: 125, y: 137},
      124: {x: 150, y: 153},
      125: {x: 176, y: 170},
      126: {x: 201, y: 187},
      127: {x: 227, y: 203},
      128: {x: 921, y: 146},
      129: {x: 892, y: 151},
      130: {x: 835, y: 83 },      
      131: {x: 804, y: 55 },      
      132: {x: 778, y: 63 },      
      133: {x: 753, y: 70 },      
      134: {x: 727, y: 78 },      
      135: {x: 561, y: 54 },      
      136: {x: 895, y: 181},
      137: {x: 894, y: 205},
      138: {x: 906, y: 260}
    };

    // Posiciones de los nodos en el lienzo (ajusta según tu imagen)
    const posiciones = {
      1: { x: 863, y: 157 },
      2: { x: 444, y: 258 },
      3: { x: 660, y: 238 },
      4: { x: 516, y: 56 },
      5: { x: 649, y: 68 },
      6: { x: 584, y: 84 },
      7: { x: 702, y: 85 },
      8: { x: 816, y: 359 },
      9: { x: 830, y: 169 },
      10: { x: 521, y: 279 },
      11: { x: 579, y: 191 },
      12: { x: 525, y: 90 },
      13: { x: 840, y: 118 },
      14: { x: 252, y: 220 },
      15: { x: 829, y: 206 },
      16: { x: 452, y: 351 },
      17: { x: 23, y: 70 },
      18: { x: 858, y: 366 },
      19: { x: 950, y: 140 },
      20: { x: 829, y: 48 },
      21: { x: 538, y: 23},
      22: { x: 927, y: 204} 
    };

    // Ajusta canvas tamaño y dibuja
    function resizeCanvas() {
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;
      draw();
    }
    window.addEventListener('resize', resizeCanvas);

    // Eventos para drag
    container.addEventListener('mousedown', e => {
      isDragging = true;
      startDrag.x = e.clientX - offsetX;
      startDrag.y = e.clientY - offsetY;
    });

    container.addEventListener('mouseup', () => {
      isDragging = false;
    });

    container.addEventListener('mouseleave', () => {
      isDragging = false;
    });

    container.addEventListener('mousemove', e => {
      if (isDragging) {
        offsetX = e.clientX - startDrag.x;
        offsetY = e.clientY - startDrag.y;
        clampOffset();
        draw();
      }
    });

    // Zoom con la rueda del mouse
    container.addEventListener('wheel', e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const zoomFactor = 0.1;
      const mouseX = (e.clientX - rect.left - offsetX) / scale;
      const mouseY = (e.clientY - rect.top - offsetY) / scale;

      if (e.deltaY < 0) {
        scale *= 1 + zoomFactor;
      } else {
        scale *= 1 - zoomFactor;
      }

      scale = Math.min(maxScale, Math.max(minScale, scale));

      offsetX = e.clientX - rect.left - mouseX * scale;
      offsetY = e.clientY - rect.top - mouseY * scale;

      clampOffset();
      draw();
    });

    // Limitar el arrastre para no sacar la imagen fuera del canvas
    function clampOffset() {
      const maxOffsetX = 0;
      const maxOffsetY = 0;
      const minOffsetX = canvas.width - image.width * scale;
      const minOffsetY = canvas.height - image.height * scale;

      offsetX = Math.min(maxOffsetX, Math.max(minOffsetX, offsetX));
      offsetY = Math.min(maxOffsetY, Math.max(minOffsetY, offsetY));
    }

    // Dibuja todo
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(offsetX, offsetY);
      ctx.scale(scale, scale);

      // Imagen de fondo
      ctx.drawImage(image, 0, 0);

      // Aristas
      ctx.strokeStyle = '#0066cc';
      ctx.lineWidth = 2;
      edges.forEach(edge => {
        const from = nodes.find(n => n.id === edge.from);
        const to = nodes.find(n => n.id === edge.to);
        if (from && to) {
          ctx.beginPath();
          ctx.moveTo(from.x, from.y);
          ctx.lineTo(to.x, to.y);
          ctx.stroke();

          // Etiqueta tiempo
          const midX = (from.x + to.x) / 2;
          const midY = (from.y + to.y) / 2;
          ctx.fillStyle = 'black';
          ctx.font = '14px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          if (edge.time) ctx.fillText(edge.time, midX, midY);
        }
      });

      // Nodos
      nodes.forEach(node => {
        ctx.beginPath();
        ctx.arc(node.x, node.y, 6, 0, 2 * Math.PI);

        if (node.id >= 23 && node.id <= 138) {
          // Subnodo: solo nodo rojo sin texto ni info
          ctx.fillStyle = "red";
          ctx.fill();
        } else {
          // Nodo principal: negro con número amarillo dentro y etiqueta al lado
          ctx.fillStyle = "black";
          ctx.fill();
          ctx.stroke();

          // Número del nodo dentro del círculo en amarillo
          ctx.fillStyle = "yellow";
          ctx.font = "bold 10px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(node.id, node.x, node.y);

          
        }
      });


      ctx.restore();
    }

    // Evento click para mostrar info en panel lateral
    container.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left - offsetX) / scale;
      const y = (e.clientY - rect.top - offsetY) / scale;

      const realX = Math.round(x);
      const realY = Math.round(y);

      console.log("📍 Coordenadas dentro del canvas:", realX, realY);

      selectedNode = null;
      for (let node of nodes) {
        const dx = node.x - x;
        const dy = node.y - y;
        if (Math.sqrt(dx * dx + dy * dy) < 10) {

          selectedNode = node;

          // 🔎 Mostrar siempre el ID, incluso de subnodos
          console.log("🟢 Nodo clickeado - ID:", node.id);

          // Mostrar info solo si no es subnodo
          if (node.id < 23 || node.id > 138) {
            panelTitle.textContent = node.label;
            panelInfo.textContent = node.info;

            if (node.carreras.length > 0) {
              const listaCarreras = node.carreras.map(c => `- ${c}`).join('<br>');
              panelCarreras.innerHTML = `<strong>Carreras:</strong><br>${listaCarreras}`;
            } else {
              panelCarreras.innerHTML = '📌 Puedes guiarte con esta foto 😀';
            }

            if (node.img) {
              panelImage.src = node.img;
              panelImage.style.display = 'block';
            } else {
              panelImage.style.display = 'none';
            }
          } else {
            // Si es subnodo, vaciar panel
            panelTitle.textContent = 'Selecciona un nodo';
            panelInfo.textContent = '';
            panelCarreras.innerHTML = '';
            panelImage.style.display = 'none';
          }

          break;
        }
      }

      if (!selectedNode) {
        panelTitle.textContent = 'Selecciona un nodo';
        panelInfo.textContent = '';
        panelCarreras.innerHTML = '';
        panelImage.style.display = 'none';
      }

      draw();
    });


    // Carga datos JSON y prepara nodos y aristas
    async function loadData(jsonFile) {
      try {
        const res = await fetch(jsonFile);
        const data = await res.json();

        if (currentMode === 'facultades') {
          nodes = data.nodes
            .filter(n => n.carreras && n.carreras.length > 0)
            .map(n => ({
              ...n,
              x: posiciones[n.id]?.x ?? 100,
              y: posiciones[n.id]?.y ?? 100
            }));
        } else {
          nodes = data.nodes.map(n => {
            const fixed = fixedSubnodePositions[n.id];
            return {
              ...n,
              x: fixed?.x ?? posiciones[n.id]?.x ?? 100,
              y: fixed?.y ?? posiciones[n.id]?.y ?? 100
            };
          });
        }

        edges = data.edges;

        // Ajustar escalado inicial
        const scaleX = container.clientWidth / image.width;
        const scaleY = container.clientHeight / image.height;
        minScale = Math.max(scaleX, scaleY);
        maxScale = minScale * 2;
        scale = minScale * 1.5;

        offsetX = (container.clientWidth - image.width * scale) / 2;
        offsetY = (container.clientHeight - image.height * scale) / 2;
        clampOffset();

        resizeCanvas();
      } catch (e) {
        alert("❌ Error al cargar el archivo JSON: " + e.message);
      }
    }


    // Esperar a que la imagen cargue para iniciar todo
    image.onload = () => {
      if (currentMode === 'facultades') {
        loadData('campus.json');
      } else {
        loadData('rutas.json');
      }
    };
  </script>
</body>
</html>
